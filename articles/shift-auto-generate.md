---
title: "æ•°ç†æœ€é©åŒ–ã§çœ‹è­·å¸«ã®ã‚·ãƒ•ãƒˆï¼ˆå‹¤å‹™è¡¨ï¼‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ã¿ãŸ"
emoji: "ğŸ‘©â€âš•ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "æ•°ç†æœ€é©åŒ–", "pulp"]
published: false
---

æœ€è¿‘ã€çœ‹è­·å¸«ã®ã‚·ãƒ•ãƒˆï¼ˆå‹¤å‹™è¡¨ï¼‰ã®è‡ªå‹•ç”Ÿæˆã«ã¤ã„ã¦èª¿æŸ»ã—ãŸã®ã§ã€ãã®å†…å®¹ã‚’å°‘ã—ã”ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

Colab ã§å®Ÿè£…ã—ãŸã®ã§ã€ãƒªãƒ³ã‚¯è²¼ã£ã¦ãŠãã¾ã™ã€‚
https://colab.research.google.com/drive/1W04EwTSQqtMtJKlK7GTXNadsLZulwcTI?usp=sharing

## ã‚·ãƒ•ãƒˆä½œæˆã£ã¦æ€ã£ã¦ã„ã‚‹ã‚ˆã‚Šé›£ã—ã„

ã‚·ãƒ•ãƒˆã®ä½œæˆã¯è·å“¡ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚„ã‚¹ã‚­ãƒ«ã€åŠ´å‹™è¦å®šãªã©è€ƒæ…®ã—ãªã„ã¨ã„ã‘ãªã„ã“ã¨ãŒå¤šãã€å®Ÿã¯ã‹ãªã‚Šè¤‡é›‘ã§ã™ã€‚

çœ‹è­·å¸«ã®ã‚·ãƒ•ãƒˆï¼ˆå‹¤å‹™è¡¨ï¼‰ä½œæˆã‚’ãƒ”ãƒƒã‚¯ã—ãŸãƒŠãƒ¼ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å•é¡Œã¨ã„ã†ãƒ†ãƒ¼ãƒãŒå­˜åœ¨ã™ã‚‹ãã‚‰ã„ã§ã™ã€‚

**å‚è€ƒ**
https://www.msi.co.jp/solution/scheduling.html

## "pulp"ã¨"deap"ã¯ã‚·ãƒ•ãƒˆã®æ•‘ä¸–ä¸»ã‹ã‚‚ã—ã‚Œãªã„

ã‚·ãƒ•ãƒˆä½œæˆã®ã«ã¤ã„ã¦èª¿æŸ»ã™ã‚‹ã¨ã€Python ã®`pulp`ã¨`deap`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã©ã¡ã‚‰ã‹ã§è§£ãè¨˜äº‹ã«ã‚ˆããƒ’ãƒƒãƒˆã—ã¾ã™ã€‚

æ•´ç†ã™ã‚‹ã¨ã€ã€ã€

- `pulp`ã¯æ•°ç†æœ€é©åŒ–ã‚’è¡Œã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªï¼ˆç·šå½¢ãªï¼‰åˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸã‚·ãƒ•ãƒˆä½œæˆã«å‘ã„ã¦ã„ã‚‹ã€‚
- `deap`ã¯éºä¼çš„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€è¤‡é›‘ãªï¼ˆéç·šå½¢ãªï¼‰åˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸã‚·ãƒ•ãƒˆä½œæˆã«å‘ã„ã¦ã„ã‚‹ã€‚

éºä¼çš„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ã€ç”Ÿç‰©ã®é€²åŒ–ã®éç¨‹ã§èµ·ãã‚‹ã€Œç’°å¢ƒã«é©å¿œã—ã€ã‚ˆã‚Šå¼·ã„å€‹ä½“ãŒç”Ÿãæ®‹ã‚Šã€ç’°å¢ƒã«é©å¿œã§ããªã„å¼±ã„å€‹ä½“ã¯æ·˜æ±°ã•ã‚Œã‚‹ã€ã¨ã„ã†ç¾è±¡ã‚’å†ç¾ã—ãŸã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãªã‚‰ã—ã„ã§ã™ã€‚

## "pulp"ã§ãƒ¢ãƒ‡ãƒ«ã‚’ä½œã£ã¦ã¿ãŸ

ä»Šå›ã¯è©¦ã—ãªã®ã§ã€ç°¡æ˜“ãªæ¡ä»¶ã‚’ pulp ã§è§£ã„ã¦ã¿ã¾ã™ã€‚

- çœ‹è­·å¸«ã•ã‚“ãŒæ¯æœˆã€1 ãƒ¶æœˆåˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆä¼‘ã¿ã®å¸Œæœ›ï¼‰ã‚’æå‡ºã™ã‚‹ã€‚
- å‹¤å‹™å½¢æ…‹ã¨ã—ã¦"æ—©ç•ª"ã¨"é…ç•ª"ãŒå­˜åœ¨ã™ã‚‹ã€‚
- "æ—©ç•ª"ã¨"é…ç•ª"ãŒé€£ç¶šã—ãªã„ã‚ˆã†ã«ã‚·ãƒ•ãƒˆã¯çµ„ã¾ã‚Œã‚‹ã€‚
- æ—¥å˜ä½ã®å¿…è¦ãªçœ‹è­·å¸«ã®äººæ•°ãŒæ±ºã¾ã£ã¦ã„ã‚‹ã€‚
- æ–°äººã®çœ‹è­·å¸«ã•ã‚“ãŒã§ãã‚‹é™ã‚Šè¢«ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚

> æœ¬æ¥ã¯ã€ä¸»ä»»ãŒå¿…ãšä¸€äººã„ã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã€ã‚·ãƒ•ãƒˆã ã‘ã§ãªãé…ç½®å…ˆã‚‚è€ƒæ…®ã™ã‚‹ã€ãªã©ã‚‚ã£ã¨åˆ¶ç´„ã¯è¤‡é›‘ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

### æ¡ä»¶ã®æ•´ç†

ã¾ãšã¯ã˜ã‚ã«æ¡ä»¶ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€åˆ¶ç´„æ¡ä»¶ã¨æœ€é©åŒ–ã™ã‚‹ç›®çš„ã‚’å®šç¾©ã—ã¾ã™ã€‚
åˆ¶ç´„æ¡ä»¶ã¯åŸºæœ¬çš„ã«å®ˆã‚‰ãªã„ã¨ã„ã‘ãªã„ã‚‚ã®ã§ã€æœ€é©åŒ–ã™ã‚‹ç›®çš„ã¯ã§ãã‚‹é™ã‚Šå®ˆã‚ŠãŸã„ã‚‚ã®ã§ã™ã€‚

ã„ã‚ã‚†ã‚‹ **"ã‚ˆã—ãªã«"** ã‚’å®Ÿç¾ã™ã‚‹ã®ãŒéƒ¨åˆ†ãŒæœ€é©åŒ–ã™ã‚‹ç›®çš„ã§ã™ã€‚

**åˆ¶ç´„æ¡ä»¶**

- è·å“¡ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆä¼‘ã¿ã®å¸Œæœ›ï¼‰ã€‚
- æ—¥å˜ä½ã®å¿…è¦ãªçœ‹è­·å¸«ã®äººæ•°ã€‚
  - ä»Šå›ã¯ 1 æ—¥ã«"æ—©ç•ª"ãŒ 2 äººã€"é…ç•ª"ãŒ 2 äººå¿…è¦ã¨ã„ã†ã“ã¨ã«ã—ã¾ã™ã€‚

**æœ€é©åŒ–ã™ã‚‹ç›®çš„**

- "æ—©ç•ª"ã¨"é…ç•ª"ãŒé€£ç¶šã—ãªã„ã€‚
- æ–°äººã®çœ‹è­·å¸«ã•ã‚“ãŒã§ãã‚‹é™ã‚Šè¢«ã‚‰ãªã„ã€‚

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ

1 ãƒ¶æœˆã‚’ 30 æ—¥ã¨ã—ã¦ã€çœ‹è­·å¸«ã•ã‚“ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆä¼‘ã¿ã®å¸Œæœ›ï¼‰ã‚’ä¼‘ã¿å¸Œæœ›ã‚’ 1ã€ãã‚Œä»¥å¤–ã‚’ 0 ã®ãƒªã‚¹ãƒˆã§è¡¨ç¾ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```py
class Nurse:
  def __init__(self, name, is_newcomer):
    self.name = name
    self.is_newcomer = is_newcomer
    self.shift_request = shift_request

  def set_shift_request(self, shift):
    self.shift_request = shift

  def set_shift(self, shift):
    self.shift = shift

shift_request = [
    0,0,0,0,0,0,0,
    0,0,0,0,1,1,0,
    0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,
    0,0
]

tanaka_tarou = Nurse('Tanaka Tarou', False)
tanaka_tarou.set_shift_request(shift_request)
```

### "pulp"ã§ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ï¼ˆåˆ¶ç´„æ¡ä»¶ï¼‰

`pulp`ã§ä¸‹è¨˜ã®åˆ¶ç´„æ¡ä»¶ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã¾ã™ã€‚

- è·å“¡ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆä¼‘ã¿ã®å¸Œæœ›ï¼‰ã€‚
- æ—¥å˜ä½ã®å¿…è¦ãªçœ‹è­·å¸«ã®äººæ•°ã€‚
  - ä»Šå›ã¯ 1 æ—¥ã«"æ—©ç•ª"ãŒ 2 äººã€"é…ç•ª"ãŒ 2 äººå¿…è¦ã¨ã„ã†ã“ã¨ã«ã—ã¾ã™ã€‚

```py
import pulp
import random

# æ—¥å˜ä½ã®å¿…è¦ãªçœ‹è­·å¸«ã®äººæ•°
request_nurses_per_early_shift = 2
request_nurses_per_late_shift = 2

# å‹¤å‹™å½¢æ…‹ï¼ˆæ—©ç•ª: e, é…ç•ª: l, ãªã—: -ï¼‰
shift_types = ['e', 'l', '-']

# ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©
lp_model = pulp.LpProblem("ShiftScheduling", pulp.LpMinimize)
x = pulp.LpVariable.dicts("shift", (range(len(nurses)), range(n_days), shift_types), cat="Binary")

# ç›®çš„é–¢æ•°
# å¾Œã§ã€å®Ÿè£…...

for d in range(n_days - 1):
  # æ—¥å˜ä½ã®å¿…è¦ãªçœ‹è­·å¸«ã®äººæ•°ã®åˆ¶ç´„
  lp_model += pulp.lpSum(x[n][d]['e'] for n in range(len(nurses))) >= request_nurses_per_early_shift
  lp_model += pulp.lpSum(x[n][d]['l'] for n in range(len(nurses))) >= request_nurses_per_late_shift

  for n in range(len(nurses)):
    # è·å“¡ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆä¼‘ã¿ã®å¸Œæœ›ï¼‰ã®åˆ¶ç´„
    if nurses[n].holiday_request[d] == 1:
      lp_model += x[n][d]['-'] == 1

lp_model.solve()
```

**çµæœ**

è‰¯ã„æ„Ÿã˜ã®çµæœãŒå‡ºã¾ã—ãŸã€‚
â€»`(x)`ã¯ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆä¼‘ã¿ã®å¸Œæœ›ï¼‰ã«ããã‚ãªã„ã‚·ãƒ•ãƒˆã§ã™ã€‚

![çµæœ](https://storage.googleapis.com/zenn-user-upload/048f445ea8b1-20231224.png)

åˆ¶ç´„æ¡ä»¶ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã§ããŸã®ã§ã€æ¬¡ã¯æœ€é©åŒ–ã™ã‚‹ç›®çš„ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã¾ã™ã€‚

### "pulp"ã§ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ï¼ˆæœ€é©åŒ–ã™ã‚‹ç›®çš„ï¼‰

`pulp`ã§ä¸‹è¨˜ã®æœ€é©åŒ–ã™ã‚‹ç›®çš„ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã¾ã™ã€‚

- "æ—©ç•ª"ã¨"é…ç•ª"ãŒé€£ç¶šã—ãªã„ã€‚
- æ–°äººã®çœ‹è­·å¸«ã•ã‚“ãŒã§ãã‚‹é™ã‚Šè¢«ã‚‰ãªã„ã€‚

å„æ¡ä»¶ã«ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ¼å€¤ã‚’è¨­å®šã—ã€ãã®åˆè¨ˆå€¤ã‚’æœ€å°åŒ–ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚
ã“ã®å®Ÿè£…ã‚’ç›®çš„é–¢æ•°ã¨å‘¼ã¶ã‚‰ã—ã„ã§ã™ã€‚

**"æ—©ç•ª"ã¨"é…ç•ª"ãŒé€£ç¶šã—ãªã„ã€‚**

ç›®çš„é–¢æ•°ã¯ï¼ˆä»Šæ—¥ã¯æ—©ç•ªã§æ¬¡ã®æ—¥ã¯é…ç•ªã‚’ç¦æ­¢ã™ã‚‹ã¿ãŸã„ãªï¼‰éç·šå½¢ãªæ¡ä»¶ã‚’ç›´æ¥çµ„ã¿è¾¼ã‚€ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€è£œåŠ©å¤‰æ•° y ã‚’å°å…¥ã—é–“æ¥çš„ã«æ¡ä»¶ã‚’çµ„ã¿è¾¼ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚

```py
# è£œåŠ©é–¢æ•°
y = pulp.LpVariable.dicts("consecutive_shift", (range(len(nurses)), range(n_days-1)), cat="Binary")

# é€£ç¶šã‚·ãƒ•ãƒˆã®ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ¼å€¤
penalty_consecutive_shift = 10

for n in range(len(nurses)):
  for d in range(n_days - 1):
    lp_model += y[n][d] >= x[n][d]['l'] + x[n][d+1]['e'] - 1
    lp_model += y[n][d] >= x[n][d]['e'] + x[n][d+1]['l'] - 1

# é€£ç¶šã‚·ãƒ•ãƒˆã®ç›®çš„é–¢æ•°
lp_model += pulp.lpSum([y[n][d] for n in range(len(nurses)) for d in range(n_days - 1)]) * penalty_consecutive_shift
```

**æ–°äººã®çœ‹è­·å¸«ã•ã‚“ãŒã§ãã‚‹é™ã‚Šè¢«ã‚‰ãªã„ã€‚**

ç›®çš„é–¢æ•°ã§å®Ÿç¾ã™ã‚‹ã®ãŒé›£ã—ãã†ãªã®ã§è«¦ã‚ã¾ã—ãŸ...
åˆ¶ç´„æ¡ä»¶ã¨ã—ã¦ãªã‚‰ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§å®Ÿè£…å¯èƒ½ã§ã™ã€‚

```py
for d in range(n_days - 1):
  # æ—¥å˜ä½ã®å¿…è¦ãªçœ‹è­·å¸«ã®äººæ•°ã®åˆ¶ç´„
  # ...

  for n in range(len(nurses)):
    # è·å“¡ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆä¼‘ã¿ã®å¸Œæœ›ï¼‰ã®åˆ¶ç´„
    # ...

    # æ–°äººã®çœ‹è­·å¸«ã•ã‚“ãŒè¢«ã‚‰ãªã„åˆ¶ç´„
    for s in shift_types:
      newcomer_assignments = pulp.lpSum(x[n][d][s] for n in range(len(nurses)) if nurses[n].is_newcomer)
      lp_model += newcomer_assignments <= 1
```

**çµæœ**

ç›®çš„é–¢æ•°ã‚‚æœŸå¾…é€šã‚Šæ©Ÿèƒ½ã—ã¦ã„ãã†ã§ã™ã€‚
â€»`(â–³)`ã¯ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ¼å¯¾è±¡ã®ã‚·ãƒ•ãƒˆã§ã™ã€‚

å®Ÿè£…å‰
![å®Ÿè£…å‰](https://storage.googleapis.com/zenn-user-upload/e6c79d366af6-20240218.png)

å®Ÿè£…å¾Œ
![å®Ÿè£…å¾Œ](https://storage.googleapis.com/zenn-user-upload/35009d6e66f5-20240218.png)

## æ„Ÿæƒ³

ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ãˆã°ã€æ¡ˆå¤–ç²¾åº¦é«˜ãã‚·ãƒ•ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã§ããã†ã€‚
ãŸã ã€"pulp"ã¯ç›®çš„é–¢æ•°å‘¨ã‚Šã®åˆ¶ç´„ãŒå³ã—ã„ãŸã‚ã€å®Ÿè£…ã™ã‚‹å‰ã«ç¢ºèªã—ã¦ãŠã„ãŸæ–¹ãŒã‚ˆã•ãã†ã€‚

â€»"deap"ã‚‚æ°—ãŒå‘ã‘ã°ã€è¨˜äº‹æ›¸ã“ã†ã¨æ€ã„ã¾ã™ã€‚
